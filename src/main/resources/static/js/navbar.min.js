$(document).ready(function(){isLogin();setAClickListener();setSearchFormValidateLisener();reloadBeforePage()});function isLogin(){$.ajax({url:requestmap.user_isLogged,type:"get",async:false,success:function(a){if(a.status===1){userInfo=a.resultMap.loggedUserInfo;$("nav.navbar ul.navbar-right:eq(1)").hide();$("nav.navbar ul.navbar-right:eq(0)").show();$("#index-navbar-ualias").text(userInfo.ualias);$("#index-navbar-uavatar").attr("src",userInfo.uavatar)}else{$("nav.navbar ul.navbar-right:eq(1)").show();$("nav.navbar ul.navbar-right:eq(0)").hide()}console.log("登陆的用户信息",userInfo)}})}function setSearchFormValidateLisener(){$("#navbar-search-form").bootstrapValidator({message:"*输入不合法",container:"#none",feedbackIcons:{valid:"glyphicon glyphicon-ok",invalid:"glyphicon glyphicon-remove",validating:"glyphicon glyphicon-refresh"},fields:{"navbar-search-form-keyword-input":{message:"*关键字不合法",validators:{notEmpty:{message:"*请输入关键字进行搜索"}}}}}).on("success.form.bv",function(a){a.preventDefault();$("#navbar-search-form-submit-button").button("loading");searchCondition.name=$("#navbar-search-form-keyword-input").val();$.get(requestmap.store_search,searchCondition,function(b){if(b.status===1){isSearchResult=true;showAllGame()}else{myAlert("未找到相关游戏!")}$("#navbar-search-form-submit-button").button("reset")})})}function setAClickListener(){$("nav.navbar ul.navbar-nav:eq(0) > li:eq(0) > a").on("click",function(){$("nav.navbar ul.navbar-nav > li").removeClass("active");$(this).parent().addClass("active")});$("nav.navbar ul.navbar-nav:eq(0) > li:eq(1) > ul > li > a").on("click",function(){$("nav.navbar ul.navbar-nav > li").removeClass("active");$(this).parent().parent().parent().addClass("active");let type=$(this).text();$(this).parent().parent().prev().html(type+"<span class='caret'></span>");restoreSearchConditonDefault();switch(type){case"免费游戏":searchCondition.minPrice=0;searchCondition.maxPrice=0;break;case"新游上线":searchCondition.tag=JSON.stringify(["newsale"]);break;case"即将上线":searchCondition.tag=JSON.stringify(["presale"]);break;case"促销游戏":searchCondition.sort="discount";break;case"动作":searchCondition.category=JSON.stringify(["动作"]);break;case"射击":searchCondition.category=JSON.stringify(["射击"]);break;case"策略":searchCondition.category=JSON.stringify(["策略"]);break;case"模拟":searchCondition.category=JSON.stringify(["模拟"]);break;case"独立":searchCondition.category=JSON.stringify(["独立"]);break;case"角色扮演":searchCondition.category=JSON.stringify(["角色扮演"]);break;case"所有游戏":break;default:break}showAllGame()});$("nav.navbar ul.navbar-nav:eq(0) > li:eq(2) > a").on("click",function(){$("nav.navbar ul.navbar-nav > li").removeClass("active");$(this).parent().addClass("active")});$("nav.navbar ul.navbar-right:eq(1) > li > a").on("click",function(){$("nav.navbar ul.navbar-nav > li").removeClass("active");$(this).parent().addClass("active")});$("nav.navbar ul.navbar-right:eq(0) > li > ul.dropdown-menu a.dropdown-item").on("click",function(){$("nav.navbar ul.navbar-nav > li").removeClass("active");let type=$(this).text();showUserPage=type.toString().replace(/\s/g,"");showUserInfo()})}function user_login(){savePage("登录");if($("#"+static_components.component_user_login.cid).length===0){loadingAnimation("#body-container").then(function(){$.get(static_components.component_user_login.curl,function(a){if(a!==undefined||a!==""){$("#body-container").html(a)}else{ajaxNoContent("#body-container")}}).fail(function(){ajaxFailed("#body-container")})})}}function user_register(){savePage("注册");if($("#"+static_components.component_user_register.cid).length===0){loadingAnimation("#body-container").then(function(){$.get(static_components.component_user_register.curl,function(a){if(a!==undefined||a!==""){$("#body-container").html(a)}else{ajaxNoContent("#body-container")}}).fail(function(){ajaxFailed("#body-container")})})}}function index_body(){savePage("首页");if($("#"+static_components.component_index.cid).length===0){loadingAnimation("#body-container").then(function(){$.get(static_components.component_index.curl,function(a){if(a!==undefined||a!==""){$("#body-container").html(a)}else{ajaxNoContent("#body-container")}}).fail(function(){ajaxFailed("#body-container")})})}}function showAllGame(){savePage("所有游戏");loadingAnimation("#body-container").then(function(){$.get(static_components.component_all_game.curl,function(a){if(a!==undefined||a!==""){$("#body-container").html(a)}else{ajaxNoContent("#body-container")}}).fail(function(){ajaxFailed("#body-container")})})}function community_index(){savePage("社区");loadingAnimation("#body-container").then(function(){$.get(static_components.component_community_index.curl,function(a){if(a!==undefined||a!==""){$("#body-container").html(a)}else{ajaxNoContent("#body-container")}}).fail(function(){ajaxFailed("#body-container")})})}function community_new_post(){if(userInfo.uid===undefined){myAlert("请登录后再执行操作!");return}savePage("发布帖子");loadingAnimation("#body-container").then(function(){$.get(static_components.component_community_new_post.curl,function(a){if(a!==undefined||a!==""){$("#body-container").html(a)}else{ajaxNoContent("#body-container")}}).fail(function(){ajaxFailed("#body-container")})})}function showUserInfo(a){a=a||0;if(a!==0){let temp=$(a).text();showUserPage=temp.toString().replace(/\s/g,"")}savePage(showUserPage);loadingAnimation("#body-container").then(function(){let showComponent;switch(showUserPage){case"我的信息":showComponent=static_components.component_user_information;break;case"我的购物车":showComponent=static_components.component_user_shopping_cart;break;case"我的愿望单":showComponent=static_components.component_user_wish_list;break;case"我的订单":showComponent=static_components.component_user_order_list;break;case"我的点评":showComponent=static_components.component_user_evaluation;break;case"我的游戏":showComponent=static_components.component_user_game;break;default:return}$.get(showComponent.curl,function(b){if(b!==undefined||b!==""){$("#body-container").html(b)}else{ajaxNoContent("#body-container")}}).fail(function(){ajaxFailed("#body-container")})})}function logout(){$.get(requestmap.user_logout,function(a){if(a.status===1){clearUserInfo();myAlert("您已成功退出!",function(){savePage("首页");$(window).attr("location","/")})}else{myAlert("退出失败了，请稍后再试!")}}).fail(function(){ajaxFailed("#body-container")})}function reloadBeforePage(){let nowPage=location.href;let lastPage=window.sessionStorage.getItem("lastPage");if(lastPage===null){$("nav.navbar ul.navbar-nav:eq(0) > li:eq(0) > a").click();return}if(lastPage!==nowPage){if(nowPage.includes("game_detail")){$("nav.navbar ul.navbar-nav:eq(0) > li:eq(1)").addClass("active");return}else{if(nowPage.includes("other_profile")){return}else{if(nowPage.includes("post_detail")){$("nav.navbar ul.navbar-nav:eq(0) > li:eq(2)").addClass("active")}else{return}}}}if(nowPage===lastPage){let type=window.sessionStorage.getItem("lastType");switch(type){case"首页":$("nav.navbar ul.navbar-nav:eq(0) > li:eq(0) > a").click();break;case"登录":$("nav.navbar ul.navbar-right:eq(1) > li:eq(0) > a").click();break;case"注册":$("nav.navbar ul.navbar-right:eq(1) > li:eq(1) > a").click();break;case"所有游戏":$("nav.navbar ul.navbar-nav:eq(0) > li:eq(1) > ul > li:last-of-type > a").click();break;case"社区":$("nav.navbar ul.navbar-nav:eq(0) > li:eq(2) > a").click();break;case"发布帖子":$("nav.navbar li.active").removeClass("active");$("nav.navbar ul.navbar-nav:eq(0) > li:eq(2)").addClass("active");community_new_post();break;default:showUserPage=type;showUserInfo();break}}}function savePage(a){let data={lastType:a,lastPage:location.href};saveData2Ses(data)};